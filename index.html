<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سنگ، کاغذ، قیچی</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        h1 {
            color: #333;
        }
        .hidden {
            display: none;
        }
        .section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .story-mode-dialogue {
            margin-top: 15px;
            font-style: italic;
            color: #555;
            min-height: 50px;
        }
        .hand {
            font-size: 80px;
        }
        #game-options button {
            font-size: 40px;
            margin: 10px;
        }
        .play-again-btn, #start-story-btn, #profile-creation-btn, .gender-btn {
            padding: 10px 20px;
            margin-top: 10px;
            cursor: pointer;
        }
        .active {
            background-color: #007bff;
            color: white;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>سنگ، کاغذ، قیچی</h1>

        <div id="start-section" class="section">
            <p>به بازی خوش آمدید!</p>
            <button id="start-story-btn">شروع داستان</button>
        </div>

        <div id="profile-creation-section" class="section hidden">
            <h3>پروفایل خود را بسازید</h3>
            <input type="text" id="player-name-input" placeholder="نام شما" maxlength="15">
            <div>
                <button class="gender-btn" data-gender="مرد">👦 مرد</button>
                <button class="gender-btn" data-gender="زن">👧 زن</button>
            </div>
            <button id="profile-creation-btn" class="hidden">تایید</button>
        </div>
        
        <div id="intro-story-section" class="section hidden">
            <p>در یک شب بارانی، شما را بی‌رحمانه گرفتند و به اینجا آوردند. این یک زندان معمولی نیست؛ اینجا میدان نبرد است، جایی برای بازی‌های مرگ و زندگی. شما راهی برای فرار از دست آنها ندارید، مگر اینکه در بازی سنگ، کاغذ، قیچی پیروز شوید.</p>
            <p>تنها انگیزه شما، نجات برادر کوچک خودتان است که او نیز در اسارت است. هر پیروزی، شما را یک قدم به آزادی او نزدیک‌تر می‌کند. شکست... به معنای پایان است.</p>
            <button class="story-button" id="start-first-stage-btn">شروع ماجراجویی</button>
        </div>

        <div id="story-mode-section" class="section hidden">
            <h2 id="story-stage-title"></h2>
            <p id="story-opponent-name"></p>
            <p id="story-dialogue" class="story-mode-dialogue"></p>
        </div>

        <div id="game-area-container" class="section hidden">
            <div id="countdown" class="game-countdown"></div>
            <div class="hands-display">
                <div id="player-hand" class="hand"></div>
                <div id="computer-hand" class="hand"></div>
            </div>
            <div id="game-options">
                <button id="rock-btn">✊</button>
                <button id="paper-btn">🖐️</button>
                <button id="scissors-btn">✌️</button>
            </div>
            <p class="score-display">شما: <span id="player-score">0</span> - حریف: <span id="computer-score">0</span></p>
        </div>

        <div id="end-game-section" class="section hidden">
            <p id="final-result"></p>
            <button class="play-again-btn">بازی دوباره</button>
        </div>

        <div id="final-story-section" class="section hidden">
            <p>با آخرین پیروزی، شما نفس‌نفس می‌زنید. نگهبانان ترسیده به شما نگاه می‌کنند. برادر کوچکتان را در آغوش می‌گیرید. صدای شلیک گلوله می‌آید، از پشت سر ... دنیا سیاه می‌شود.
            <br><br>
            منتظر فصل دوم باشید . . .</p>
        </div>
    </div>

    <script>
        const gameChoices = document.querySelectorAll('#game-options button');
        const startStoryBtn = document.getElementById('start-story-btn');
        const introStorySection = document.getElementById('intro-story-section');
        const startFirstStageBtn = document.getElementById('start-first-stage-btn');
        const profileCreationSection = document.getElementById('profile-creation-section');
        const playerNameInput = document.getElementById('player-name-input');
        const genderOptions = document.querySelectorAll('.gender-btn');
        const profileCreationBtn = document.getElementById('profile-creation-btn');
        const storyModeSection = document.getElementById('story-mode-section');
        const storyStageTitle = document.getElementById('story-stage-title');
        const storyOpponentName = document.getElementById('story-opponent-name');
        const storyDialogue = document.getElementById('story-dialogue');
        const gameAreaContainer = document.getElementById('game-area-container');
        const endGameStateSection = document.getElementById('end-game-section');
        const finalResultDisplay = document.getElementById('final-result');
        const finalStorySection = document.getElementById('final-story-section');
        const playAgainBtns = document.querySelectorAll('.play-again-btn');

        const choices = ['rock', 'paper', 'scissors'];
        const rules = {
            rock: 'scissors',
            paper: 'rock',
            scissors: 'paper'
        };

        const choiceIcons = {
            rock: '✊',
            paper: '🖐️',
            scissors: '✌️'
        };
        
        let playerName = '';
        let playerGender = '';
        let playerScore = 0;
        let computerScore = 0;
        let playerHistory = [];
        let isGameActive = false;
        let currentStageIndex = 0;
        let countdownInterval;

        const storyStages = [
            { name: "گارد یک", difficulty: "easy", dialogueStart: "فکر کردی می‌تونی از اینجا فرار کنی؟ برو به برادرت ملحق شو.", dialogueWin: "عجب! تو قوی‌تر از چیزی بودی که فکر می‌کردم، {name}.", dialogueLose: "نخیر... تو اینجا می‌مونی، {name}." },
            { name: "گارد دو", difficulty: "easy", dialogueStart: "بیا این بازی رو شروع کنیم تا زودتر تموم بشه. می‌خوام به خونه برم.", dialogueWin: "تو خیلی قوی هستی، {name}. امیدوارم به برادرت برسی.", dialogueLose: "تو اینجا گیر افتادی. مثل همه ما." },
            { name: "نگهبان بی‌رحم", difficulty: "medium", dialogueStart: "شنیدم برای نجات برادرت اومدی، {name}. داستانت خیلی قشنگه، ولی هیچوقت به پایان خوش نمی‌رسه.", dialogueWin: "غیرممکنه! از این آدمای احمق همیشه بهتر بودم. تو کی هستی؟", dialogueLose: "بهت که گفتم داستانت پایان خوش نداره." },
            { name: "رئیس بی‌رحم", difficulty: "hard", dialogueStart: "تو اینجا چه کار می‌کنی؟ تو که نمی‌تونی از این کارها بکنی. تو فقط یک آدم معمولی هستی.", dialogueWin: "عالی بود، آماده‌ام برای مرحله بعد.", dialogueLose: "فقط یک شانس بود!" },
            { name: "پروفسور مریم", difficulty: "hard", dialogueStart: "من الگوریتم‌های بازی رو خودم نوشتم. شانسی نداری.", dialogueWin: "غیرممکنه! چطور الگوریتم من رو شکستی؟", dialogueLose: "همیشه می‌دونم داری چه کاری می‌کنی." },
            { name: "بازیکن نهایی", difficulty: "hard", dialogueStart: "اینجا پایان راه است. آیا آماده‌ای؟", dialogueWin: "تو برنده هستی... کل بازی رو بردی! بهت افتخار می‌کنم!", dialogueLose: "این پایان راه برای توست." },
        ];

        function showSection(id) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        function saveProfile() {
            localStorage.setItem('playerName', playerName);
            localStorage.setItem('playerGender', playerGender);
        }

        function loadProfile() {
            playerName = localStorage.getItem('playerName');
            playerGender = localStorage.getItem('playerGender');
            if (playerName && playerGender) {
                showSection('start-section');
            } else {
                showSection('profile-creation-section');
            }
        }

        startStoryBtn.addEventListener('click', () => {
            showSection('intro-story-section');
        });

        startFirstStageBtn.addEventListener('click', () => {
            showSection('story-mode-section');
            showSection('game-area-container');
            startStage(currentStageIndex);
        });

        genderOptions.forEach(btn => {
            btn.addEventListener('click', () => {
                genderOptions.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                playerGender = btn.dataset.gender;
                checkProfileReady();
            });
        });

        playerNameInput.addEventListener('input', () => {
            checkProfileReady();
        });

        profileCreationBtn.addEventListener('click', () => {
            playerName = playerNameInput.value.trim();
            if (playerName && playerGender) {
                saveProfile();
                showSection('start-section');
                startStoryBtn.click();
            }
        });

        function checkProfileReady() {
            if (playerNameInput.value.trim() && playerGender) {
                profileCreationBtn.classList.remove('hidden');
            } else {
                profileCreationBtn.classList.add('hidden');
            }
        }
        
        gameChoices.forEach(button => {
            button.addEventListener('click', (e) => {
                if (!isGameActive) return;
                isGameActive = false;
                
                const playerChoice = e.target.id.replace('-btn', '');
                playerHistory.push(playerChoice);
                
                const computerChoice = getComputerChoice();
                
                showHands(playerChoice, computerChoice);
                
                setTimeout(() => {
                    const result = determineWinner(playerChoice, computerChoice);
                    updateScores(result);
                    progressStory(result);
                }, 3000);
            });
        });

        function startStage(stageIndex) {
            if (stageIndex >= storyStages.length) {
                endStoryMode(true);
                return;
            }
            
            const stage = storyStages[stageIndex];
            
            storyStageTitle.textContent = `مرحله ${stageIndex + 1}`;
            storyOpponentName.textContent = `حریف: ${stage.name}`;
            storyDialogue.textContent = stage.dialogueStart.replace('{name}', playerName);
            
            resetGame();
            isGameActive = true;
        }

        function progressStory(result) {
            const stage = storyStages[currentStageIndex];
            const dialogue = result === 'win' ? stage.dialogueWin : stage.dialogueLose;
            storyDialogue.textContent = dialogue.replace('{name}', playerName);
            
            setTimeout(() => {
                if (result === 'win') {
                    if (currentStageIndex === storyStages.length - 1) {
                        endStoryMode(true);
                    } else {
                        currentStageIndex++;
                        startStage(currentStageIndex);
                    }
                } else {
                    endStoryMode(false);
                }
            }, 2000);
        }

        function endStoryMode(isWinner) {
            isGameActive = false;
            showSection('end-game-section');
            if (isWinner) {
                showSection('final-story-section');
            } else {
                finalResultDisplay.textContent = `شما شکست خوردید.`;
                showSection('end-game-section');
            }
        }
        
        function showHands(playerChoice, computerChoice) {
            let count = 3;
            document.getElementById('countdown').textContent = count;
            document.getElementById('player-hand').textContent = choiceIcons[playerChoice];
            document.getElementById('computer-hand').textContent = '✊';
            
            countdownInterval = setInterval(() => {
                count--;
                if (count >= 0) {
                    document.getElementById('countdown').textContent = count > 0 ? count : 'برو!';
                } else {
                    clearInterval(countdownInterval);
                    document.getElementById('countdown').textContent = '';
                    document.getElementById('player-hand').textContent = choiceIcons[playerChoice];
                    document.getElementById('computer-hand').textContent = choiceIcons[computerChoice];
                }
            }, 1000);
        }

        function getComputerChoice() {
            const lastTwoMoves = playerHistory.slice(-2);
            if (lastTwoMoves.length >= 2 && lastTwoMoves[0] === lastTwoMoves[1]) {
                return rules[lastTwoMoves[0]];
            }
            return choices[Math.floor(Math.random() * choices.length)];
        }

        function determineWinner(playerChoice, computerChoice) {
            if (playerChoice === computerChoice) return 'draw';
            if (rules[playerChoice] === computerChoice) return 'win';
            return 'lose';
        }

        function updateScores(result) {
            if (result === 'win') {
                playerScore++;
            } else if (result === 'lose') {
                computerScore++;
            }
            document.getElementById('player-score').textContent = playerScore;
            document.getElementById('computer-score').textContent = computerScore;
        }

        function resetGame() {
            playerScore = 0;
            computerScore = 0;
            document.getElementById('player-score').textContent = 0;
            document.getElementById('computer-score').textContent = 0;
            document.getElementById('countdown').textContent = '';
            document.getElementById('player-hand').textContent = '';
            document.getElementById('computer-hand').textContent = '';
        }

        playAgainBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                window.location.reload();
            });
        });

        window.onload = loadProfile;
    </script>
</body>
</html>
